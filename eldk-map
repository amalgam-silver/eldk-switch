#!/bin/bash

DATA=$(dirname $0)/eldk-map.dat

usage () {
    echo "usage: $(basename $0) <from> <to> <key>"				1>&2
    echo "	The table { <from>, <to> } is queried for <from> = <key>"	1>&2
    echo "	where <from> and <to> are fieldnames."				1>&2
    echo "       $(basename $0) <column>"					1>&2
    echo "	Lists all possible values for <column> where"			1>&2
    echo "	<column> is a fieldname."					1>&2
    echo "	Valid field names: 'board', 'cpu', 'eldkcc', 'alias'"		1>&2
    echo "	(can be abbreviated as 'b', 'c', 'e', 'a')"			1>&2
    echo ""									1>&2
    echo "	Examples:"							1>&2
    echo "	eldk-map c b ppc440epx  - show all boards using 440EPx"		1>&2
    echo "	eldk-map e b ppc_8xx    - show all boards using ppc_8xx-"	1>&2
    echo "	  as CROSS_COMPILE."						1>&2
    echo "	eldk-map c              - show all known CPUs"			1>&2
    exit 1
}

toupper () {
    echo $1 | tr 'a-z' 'A-Z'
}

tolower () {
    echo $1 | tr 'A-Z' 'a-z'
}

# "Database" accessor functions
# Get a section from our datafile
get_section () {
    sed -n '/:section '$1':/I,/:section/I {s/#.*//; /^$/d; p}' < $DATA
}

# Match first column
match_first_col () {
    sed -n '/^'"$1"'/I { s/^.*[ \t]\+\(.\+\)$/\1/ ; p }'
}

# Match second column
match_second_col () {
    sed -n '/'"$1"'$/I { s/^\(.\+\)[ \t]\+.*$/\1/ ; p }'
}

# Get column
get_col () {
    sed 's/^\(.\+\)[ \t]\+\(.\+\)$/\'"$1"'/'
}

if [ $# -eq 1 ]
then
    # Lookup all values
    column=$(tolower $1)
    case ${column:0:1} in
	a)	get_section alias_to_eldkcc | get_col 1 | sort | uniq ;;
	b)      get_section board_to_cpu | get_col 1 | sort | uniq ;;
	c)	get_section cpu_to_eldkcc | get_col 1 | sort | uniq ;;
	e)      get_section cpu_to_eldkcc | get_col 2 | sort | uniq ;;
	v)	
	    for cpu in $(get_section board_to_cpu | get_col 2) ; do
		if [ -z "$(get_section cpu_to_eldkcc | match_first_col $(toupper $cpu))" ] ; then
		    echo "Unknown CPU: $cpu" 1>&2
		fi
	    done ;;
	*)	echo "$0: unknown column $1" 1>&2 ; exit 1 ;;
    esac
elif [ $# -eq 3 ]
then
    # Map a $key through a table
    from=$(tolower $1)
    to=$(tolower $2)
    key=$(toupper $3)

    case "${from:0:1},${to:0:1}" in
	a,e)    get_section alias_to_eldkcc | match_first_col $key ;;
	b,c)	get_section board_to_cpu | match_first_col $key ;;
	c,e)	get_section cpu_to_eldkcc | match_first_col $key ;;
	c,b)	get_section board_to_cpu | match_second_col $key ;;
	e,c)	get_section cpu_to_eldkcc | match_second_col $key ;;
	e,b)
	    for cpu in $(get_section cpu_to_eldkcc | match_second_col $key) ; do
		get_section board_to_cpu | match_second_col $(toupper $cpu)
	    done ;;
	*)  echo "$0: unknown lookup operation $from -> $to" 1>&2
	    exit 1 ;;
    esac
else
    usage
fi
